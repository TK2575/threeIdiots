---
title: "Divisional Futures"
author: "Tom Kain"
date: "April 1, 2019"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE
)
library(tidyverse)
library(janitor)
library(knitr)
library(glue)
source("R/standings.R")
```
## Draft Results and Preseason Projections
```{r}
picks <- read_csv("data/2019_mlbFutures_picks.csv") %>% 
  clean_names() %>% 
  mutate(pick = row_number(),
         round = (pick / 3) %>% ceiling())

colors <- read_csv("data/team_colors.csv")
```
```{r}
preseason_proj <- picks %>%
  mutate(avg_wins = (proj_538 + proj_fangraphs) / 2,
         points_proj = case_when(
           inverted ~ 162 - avg_wins,
           TRUE ~ avg_wins
         )) %>% 
  left_join(colors, by = "team")
```
```{r}
preseason_proj %>% 
  mutate(player = fct_reorder(player, pick),
         invert_display = if_else(inverted, " (Inverted)", ""),
         team = glue("{team} - {division}{invert_display}")) %>% 
  select(player, round, team) %>% 
  spread(player, team) 

preseason_proj_by_round <- preseason_proj %>% 
  mutate(player = fct_reorder(player, pick)) %>% 
  select(player, round, points_proj) %>%
  spread(player, points_proj) %>% 
  mutate(round = round %>% as.character())

preseason_proj_by_round %>% 
  select(-round) %>% 
  summarise_all(sum) %>% 
  mutate(round = "Total") %>%
  bind_rows(preseason_proj_by_round) %>% 
  select(round, Tom:Dad) %>% 
  arrange(round) 

```

```{r}
standings <- get_standings()
```

```{r}
picks_latest <- preseason_proj %>% 
  select(-division) %>% 
  left_join(standings, by = c("abbrev" = "tm")) %>% 
  mutate(points = if_else(inverted,l,w),
         w_pace = ceiling(w_l_percent * 162),
         l_pace = 162-w_pace,
         points_pace = if_else(inverted,l_pace,w_pace),
         w_pyth = ceiling(pyth_w_l_percent * 162),
         l_pyth = 162-w_pyth,
         points_pyth = if_else(inverted,l_pyth,w_pyth)) 

picks_latest %>% 
  group_by(player) %>% 
  summarize_at(vars(points, points_proj, points_pace, points_pyth), sum)
```

```{r}
plot_df <- preseason_proj %>% 
  mutate(player = fct_reorder(player, pick)) %>% 
  mutate(team = fct_reorder(team, points_proj)) %>%
  arrange(desc(points_proj)) %>% 
  group_by(player) %>% 
  mutate(pos = cumsum(points_proj) - points_proj/2)

cols <- plot_df$color1
names(cols) <- plot_df$team

label_cols <- plot_df$color2
names(label_cols) <- plot_df$team

# FIXME colors getting confused
plot_df %>% 
  ggplot(aes(x=player,
             y=points_proj,
             fill=team)) +
  geom_col(aes(text = glue("color1 = {color1}; color2 = {color2}")), 
           position = "stack") +
  scale_fill_manual(values=cols) +
  geom_text(aes(x=player,y=pos,label=team,color=team), size=5) +
  scale_color_manual(values=label_cols) +
  theme(legend.position="none") -> p
  
plotly::ggplotly(p)
```

#### To Do

1. Abstract the plotting so that it can be displayed for current and various projected point totals
2. Capture weekly standings and trend point totals week by week.